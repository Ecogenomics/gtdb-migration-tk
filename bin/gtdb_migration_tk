#!/usr/bin/env python3
###############################################################################
#                                                                             #
#    This program is free software: you can redistribute it and/or modify     #
#    it under the terms of the GNU General Public License as published by     #
#    the Free Software Foundation, either version 3 of the License, or        #
#    (at your option) any later version.                                      #
#                                                                             #
#    This program is distributed in the hope that it will be useful,          #
#    but WITHOUT ANY WARRANTY; without even the implied warranty of           #
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #r
#    GNU General Public License for more details.                             #
#                                                                             #
#    You should have received a copy of the GNU General Public License        #
#    along with this program. If not, see <http://www.gnu.org/licenses/>.     #
#                                                                             #
###############################################################################

__author__ = "Pierre Chaumeil"
__copyright__ = "Copyright 2019"
__credits__ = ["Donovan Parks", "Pierre Chaumeil", "Aaron Mussig"]
__license__ = "GPL3"
__maintainer__ = "Pierre Chaumeil"
__email__ = "uqpchaum@uq.edu.au"
__status__ = "Development"


import os
import argparse
import sys
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# Specific import
from gtdb_migration_tk.main import OptionsParser
from biolib.logger import logger_setup
from biolib.misc.custom_help_formatter import CustomHelpFormatter
from gtdb_migration_tk import __version__


def print_help():
    """Help menu."""

    print('')
    print('                ...::: GTDB Migration Toolkit v' +
          __version__ + ' :::...''')
    print('''\

    NCBI folder to GTDB folder:
      update_refseq  -> Update Refseq genomes.
      update_genbank -> Update Genbank genomes.

    Call genes:
      call_genes_wf -> Full call genes workflow
                       (prodigal -> hmmsearch -> top_hit )
      prodigal       -> Call genes using Prodigal
      prodigal_check -> Check if table used by Prodigal is the same as the
                        one indicated in NCBI.
      hmmsearch      -> Search Tigrfam/Pfam markers genes and generate tophit files
      top_hit        -> generate tophits file
      metadata       -> Generate metadata derived from nucleotide (e.g., GC) and protein (e.g., gene count) files.
      rna_silva      -> Identifies, extracts, and taxonomically classifies 16S and 23S rRNA genes in genomes against SILVA
      rna_ltp        -> Identify, extract, and taxonomically classify 16S rRNA genes against the LTP DB.
      trnascan       -> Identifies tRNAs in genomes.
      join_checkm    -> Join CheckM output files for different releases
      checkm         -> Estimates the quality of the new genomes
      
     Access to Database:
     update_db          -> Update the gtdb database
     update_checkm_db   -> Import CheckM estimates
     update_metadata_db -> Update metadata in database

    Metadata:
      create_tables     -> Create tables with metadata for all genomes (currently only NCBI)
      parse_assemblies  -> Create tables with metadata for all NCBI genomes from assembly summaries
      parse_ncbi_dir    -> Create tables with metadata for all NCBI genomes from directories

    NCBI Taxonomy:
      parse_ncbi_taxonomy   -> Create summary files of the NCBI taxonomy file.
      
    GTDB Taxonomy:
      propagate_gtdb_taxonomy -> Propagating GTDB taxonomy to new release 
      update_propagate_tax    -> Push propagated taxonomy to new DB

    Information from Nomenclatural resources:
      lpsn     -> Process steps for LPSN.
      bacdive  -> Process steps for BacDive. [In Dev]
      strains  -> Set of tools to combined information from LPSN and DSMZ.
      ncbi_strains -> Parse the assembly report file, the genomic.gbff file and the wgsmaster.gbff to find all strain ids
      
    Curation files
      curation_lists -> Lists and pseudo-trees for new representatives, polyphyletic taxa, rogue genomes, and genomes with modified NCBI names

    Miscellaneous commands:
      list_genomes -> Produce file indicating the directory of each genome.

    Test suite for data validation:
      overview             -> Compare the Metadata file from the previous version with the new one.
      compare_field        -> Compare a specific metadata field between to metadata files.
      check_unique_strains -> Check if a genomes has to different strains from a same collection.


  Use: gtdb_migration_tk <command> -h for command specific help.

  Feature requests or bug reports can be sent to Donovan Parks (donovan.parks@gmail.com)
    or posted on GitHub (https://github.com/Ecogenomics/gtdb_migration_tk).
    ''')


if __name__ == '__main__':

    # initialize the options parser
    parser = argparse.ArgumentParser(add_help=True)
    subparsers = parser.add_subparsers(help="--", dest='subparser_name')
    
    # Clean FTP server
    clean_ftp_parser = subparsers.add_parser(
        'clean_ftp', formatter_class=CustomHelpFormatter, description='Clean the FTP directory.')
    clean_ftp_parser.add_argument('-n',
                                 '--new_list_genomes', help='files indicating the Gid present in the new release (comma separated).', required=True)
    clean_ftp_parser.add_argument('-f',
                                 '--ftp_genome_dir_file', help='Genome directory file for the FTP server.', required=True)
    clean_ftp_parser.add_argument('-d',
                                 '--ftp_genome_dir', help='FTP Genome directory.', required=True)
    clean_ftp_parser.add_argument('-r',
                                 '--report_dir', help='output directory to list reports.', required=True)
    clean_ftp_parser.add_argument('-t',
                                 '--taxonomy_file', help='Standardised taxonomy file from NCBI.')
                                                                  
    clean_ftp_parser.add_argument(
        '--silent', help="suppress output", action='store_true')                                 

    # Call genes with prodigal
    prodigal_parser = subparsers.add_parser(
        'prodigal', formatter_class=CustomHelpFormatter, description='Call genes using Prodigal.')
    prodigal_parser.add_argument('-g',
                                 '--gtdb_genome_path_file', help='file indicating path to GTDB genomes.', required=True)
    prodigal_parser.add_argument(
        '--tmp_dir', help='temporary directory for storing intermediate results', default='/tmp')
    prodigal_parser.add_argument('-c', '--cpus', type=int,
                                 help='number of threads', default=1)
    prodigal_parser.add_argument('-l', '--log', required=True,
                                  help='Log file.')
    prodigal_parser.add_argument(
        '--all', dest='all_genomes', help="re run all genomes", action='store_true')
    prodigal_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    # Call genes
    prodigal_check_parser = subparsers.add_parser(
        'prodigal_check', formatter_class=CustomHelpFormatter, description='Check if table used by Prodigal is the same as the one indicated in NCBI.')
    prodigal_check_parser.add_argument('-g',
                                       '--gtdb_genome_path_file', help='file indicating path to GTDB genomes.', required=True)
    prodigal_check_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    # Search Pfam Tigrfam markers
    hmmsearch_parser = subparsers.add_parser(
        'top_hit', formatter_class=CustomHelpFormatter, description='Generate TopHit file for Tigrfam or Pfam.')
    hmmsearch_parser.add_argument('-g',
                                  '--gtdb_genome_path_file', help='file indicating path to GTDB genomes.', required=True)
    hmmsearch_parser.add_argument('-c', '--cpus', type=int,
                                  help='number of threads', default=1)
    hmmsearch_parser.add_argument('-d', '--db',
                                  help='pfam or tigrfam.', choices=['pfam', 'tigrfam'])
    hmmsearch_parser.add_argument('-l', '--log', required=True,
                                  help='Log file.')
    hmmsearch_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    metadata_parser = subparsers.add_parser(
        'metadata', formatter_class=CustomHelpFormatter, description='generate metadata derived from nucleotide (e.g., GC) and protein (e.g., gene count) files.')
    metadata_parser.add_argument('-g',
                                 '--gtdb_genome_path_file', help='file indicating path to GTDB genomes.', required=True)
    metadata_parser.add_argument('-c', '--cpus', type=int,
                                 help='number of threads', default=1)
    metadata_parser.add_argument('-l', '--log', required=True,
                                  help='Log file.')
    metadata_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    update_silva_parser = subparsers.add_parser("update_silva",description="Update the Taxonomy files and Blast database based on the latest Silva release")
    update_silva_parser.add_argument('--ssu_ref', help='SILVA_xxx_SSURef_NR99_tax_silva.fasta file downloaded from Silva.', required=True)
    update_silva_parser.add_argument('--lsu_ref', help='SILVA_xxx_LSURef_tax_silva.fasta file downloaded from Silva.', required=True)
    update_silva_parser.add_argument('-o', '--out_dir',
                                    help = 'Output directory.', required = True)
    update_silva_parser.add_argument('-l','--log', required=True,help="log file")
    update_silva_parser.add_argument(
        '--silent', help="suppress output", action='store_true')


    rna_silva_parser = subparsers.add_parser(
        'rna_silva', formatter_class=CustomHelpFormatter, description='Identifies, extracts, and taxonomically classifies 16S and 23S rRNA genes in genomes against SILVA')
    rna_silva_parser.add_argument('-g',
                                  '--gtdb_genome_path_file', help='file indicating path to GTDB genomes.', required=True)
    rna_silva_parser.add_argument('-c', '--cpus', type=int,
                                  help='number of threads', default=1)
    rna_silva_parser.add_argument('-v', '--version',
                                  help='rna Silva version', default=0)
    rna_silva_parser.add_argument('-p', '--rnapath',
                                  help='path to rna Silva file', default='/srv/whitlam/bio/db/silva/')
    rna_silva_parser.add_argument('-r','--rna_gene', choices=[
                        'ssu', 'lsu_23S', 'lsu_5S'], help="rRNA gene to process")
    rna_silva_parser.add_argument('-l','--log', required=True,help="log file")
    rna_silva_parser.add_argument(
        '--silent', help="suppress output", action='store_true')


    rna_ltp_parser = subparsers.add_parser(
        'rna_ltp', formatter_class=CustomHelpFormatter, description='Identifies, extracts, and taxonomically classifies 16S and 23S rRNA genes in genomes against SILVA')
    rna_ltp_parser.add_argument('-g',
                                  '--gtdb_genome_path_file', help='file indicating path to GTDB genomes.', required=True)
    rna_ltp_parser.add_argument('-c', '--cpus', type=int,
                                  help='number of threads', default=1)
    rna_ltp_parser.add_argument('--ltp_version', type=int,
                                  help='rna Silva version', default=0)
    rna_ltp_parser.add_argument('--ssu_version', type=int,
                                      help='rna Silva version', default=0)
    rna_ltp_parser.add_argument('-p', '--rnapath',
                                  help='path to rna Silva file', default='/srv/whitlam/bio/db/silva/')
    rna_ltp_parser.add_argument('-l','--log', required=True,help="log file")
    rna_ltp_parser.add_argument(
        '--all', dest='all_genomes', help="re run all genomes", action='store_true')
    rna_ltp_parser.add_argument(
        '--silent', help="suppress output", action='store_true')


    trnascan_parser = subparsers.add_parser(
        'trnascan', formatter_class=CustomHelpFormatter, description='Identifies tRNAs in genomes')
    trnascan_parser.add_argument('-g',
                                  '--gtdb_genome_path_file', help='file indicating path to GTDB genomes.', required=True)
    trnascan_parser.add_argument('-c', '--cpus', type=int,
                                  help='number of threads', default=1)
    trnascan_parser.add_argument('--gbk_bac_assembly_file',
                        help='Assembly summary file downloaded from NCBI')
    trnascan_parser.add_argument('--gbk_arc_assembly_file',
                        help='Assembly summary file downloaded from NCBI')
    trnascan_parser.add_argument('--rfq_arc_assembly_file',
                        help='Assembly summary file downloaded from NCBI')
    trnascan_parser.add_argument('--rfq_bac_assembly_file',
                        help='Assembly summary file downloaded from NCBI')
    trnascan_parser.add_argument('-l', '--log', required=True,
                                  help='Log file.')
    trnascan_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    join_checkm_parser = subparsers.add_parser('join_checkm',
        formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    join_checkm_parser.add_argument('-f',
                                  '--checkm_files', help='Output CheckM files from differents releases.',nargs="+", required=True)
    join_checkm_parser.add_argument('-o',
                                  '--output_file', help='Output file merging the different releases.', required=True)
    join_checkm_parser.add_argument('-l', '--log', required=True,
                                  help='Log file.')
    join_checkm_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    checkm_parser = subparsers.add_parser('checkm',
        formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    checkm_parser.add_argument('-g',
                                  '--gtdb_genome_path_file', help='file indicating path to GTDB genomes.', required=True)
    checkm_parser.add_argument('--report', help='report log indicating new, modified, unmodified, ..., genomes')
    checkm_parser.add_argument('-o','--output_dir', help='output directory')
    checkm_parser.add_argument(
        '--all', dest='all_genomes', help="re run all genomes", action='store_true')
    checkm_parser.add_argument('-c', '--cpus', type=int,
                                  help='number of threads', default=1)
    checkm_parser.add_argument('-l', '--log', required=True,
                                  help='Log file.')
    checkm_parser.add_argument(
        '--silent', help="suppress output", action='store_true')
        
    # Commands to Update database
    update_db_parser = subparsers.add_parser(
        'update_db', formatter_class=CustomHelpFormatter, description='Ypdate the Postgres database.')
    update_db_parser.add_argument('--hostname', required=True)
    update_db_parser.add_argument('-u', '--user', 
                                  help='psql user',  required=True)
    update_db_parser.add_argument('-p', '--password', 
                                  help='password for psql user',  required=True)
    update_db_parser.add_argument('-d', '--db',
                                  help='database.',  required=True)
    update_db_parser.add_argument('--path_to_log',
                                  help='Path to log file.',dest='output_dir',  required=True)
    update_db_parser.add_argument('-c',
                                  '--checkm_profile_new_genomes', required=True)
    update_db_parser.add_argument('-g', '--genome_dirs_file', 
                                  help='file listing all paths to NCBI genomes',  required=True)
    update_db_parser.add_argument('-f', '--ftp_download_date',
                                  help='Date when data was downloaded.')
    update_db_parser.add_argument('-r', '--repository',
                                  help='NCBI repo.',choices=['refseq','genbank'])
    update_db_parser.add_argument('-l', '--log', required=True, help="Log file")
    update_db_parser.add_argument('--cpus', type=int,
                                  help='number of threads', default=1)
    update_db_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    # Commands to Update CheckM value in DB
    update_checkm_db_parser = subparsers.add_parser(
        'update_checkm_db', formatter_class=CustomHelpFormatter, description='Update the CheckM value in Postgres database.')
    update_checkm_db_parser.add_argument('--hostname', required=True)
    update_checkm_db_parser.add_argument('-u', '--user',
                                  help='psql user', required=True)
    update_checkm_db_parser.add_argument('-p', '--password',
                                  help='password for psql user', required=True)
    update_checkm_db_parser.add_argument('-d', '--db',
                                  help='database.', required=True)
    update_checkm_db_parser.add_argument('--checkm_profiles',
                                  help='CheckM profile file for all genomes of interest',  required=True)
    update_checkm_db_parser.add_argument('-q', '--check_qa',
                                  help='CheckM QA file for 100%% strain heterogeneity for all genomes of interest')
    update_checkm_db_parser.add_argument('-m', '--metadata',
                                  help='Metadata file generated from "gdb metadata export".')
    update_checkm_db_parser.add_argument('-l', '--log', required=True, help="Log file")
    update_checkm_db_parser.add_argument(
        '--silent', help="suppress output", action='store_true')


    update_metadata_db_parser = subparsers.add_parser(
        'update_metadata_db', formatter_class=CustomHelpFormatter, description='Update information inf the database.')
    update_metadata_db_parser.add_argument('--hostname', required=True)
    update_metadata_db_parser.add_argument('-u', '--user',
                                  help='psql user', required=True)
    update_metadata_db_parser.add_argument('-p', '--password',
                                  help='password for psql user', required=True)
    update_metadata_db_parser.add_argument('-d', '--db',
                                  help='database.', required=True)
    update_metadata_db_parser.add_argument('-i', '--input_folder',
                                  help='Directory folder with all the tables created by metadata.')
    update_metadata_db_parser.add_argument('-f', '--metadata_table',
                                  help='Specific metadata table.')
    update_metadata_db_parser.add_argument('--metadata_table_desc',
                                  help='Specific metadata table description file.')
    update_metadata_db_parser.add_argument('--genome_list', help='only process genomes in this list', default=None)
    update_metadata_db_parser.add_argument('--do_not_null_field',help='Do not set fields to NULL for all genomes before updating values',
                        action='store_true')
    update_metadata_db_parser.add_argument('-l', '--log', required=True, help="Log file")
    update_metadata_db_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    update_ncbitax_db_parser = subparsers.add_parser(
        'update_ncbitax_db', formatter_class=CustomHelpFormatter, description='Update Organism name in the database.')
    update_ncbitax_db_parser.add_argument('--hostname', required=True)
    update_ncbitax_db_parser.add_argument('-u', '--user',
                                  help='psql user', required=True)
    update_ncbitax_db_parser.add_argument('-p', '--password',
                                  help='password for psql user', required=True)
    update_ncbitax_db_parser.add_argument('-d', '--db',
                                  help='database.', required=True)
    update_ncbitax_db_parser.add_argument('-o','--organism_name_file', help='NCBI Organism name file.', required=True)
    update_ncbitax_db_parser.add_argument('--filtered', help='Filtered taxonomy file.', required=True)
    update_ncbitax_db_parser.add_argument('--unfiltered', help='Unfiltered taxonomy file.', required=True)
    update_ncbitax_db_parser.add_argument('--genome_list', help='only process genomes in this list', default=None)
    update_ncbitax_db_parser.add_argument('--do_not_null_field',help='Do not set fields to NULL for all genomes before updating values',
                        action='store_true')
    update_ncbitax_db_parser.add_argument(
        '--silent', help="suppress output", action='store_true')


    # Search Pfam Tigrfam markers
    hmmsearch_parser = subparsers.add_parser(
        'hmmsearch', formatter_class=CustomHelpFormatter, description='Call Hmmsearch on new and modified genomes.')
    hmmsearch_parser.add_argument('-g',
                                  '--gtdb_genome_path_file', help='file indicating path to GTDB genomes.', required=True)
    hmmsearch_parser.add_argument('-c', '--cpus', type=int,
                                  help='number of threads', default=1)
    hmmsearch_parser.add_argument('-d', '--db',
                                  help='pfam or tigrfam.', choices=['pfam', 'tigrfam'])
    hmmsearch_parser.add_argument(
        '--tmp_dir', help='temporary directory for storing intermediate results', default='/tmp')

    hmmsearch_parser.add_argument(
        '-r', '--report', help='reports file generated by update steps.')
    hmmsearch_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    # Create metadata tables
    create_tables_parser = subparsers.add_parser('create_tables', formatter_class=CustomHelpFormatter,
                                                    description='Create tables with metadata for all NCBI genomes.')
    create_tables_parser.add_argument('-g',
                                      '--gtdb_genome_path_file', help='file indicating path to GTDB genomes.', required=True)
    create_tables_parser.add_argument('-o',
                                          '--output_dir', help='Output directory.', required=True)
    create_tables_parser.add_argument('-s',
                                          '--silva_version', help='Silva version.', required=True)
    create_tables_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    # Create metadata tables for NCBI
    create_ncbi_tables_parser = subparsers.add_parser('parse_assemblies', formatter_class=CustomHelpFormatter,
                                                    description='Parse assembly summary file to generate metadata.')
    create_ncbi_tables_parser.add_argument('--rb',help='RefSeq assembly summary file (assembly_summary_refseq.txt) for Bacteria', required=True)
    create_ncbi_tables_parser.add_argument('--ra',help='RefSeq assembly summary file (assembly_summary_refseq.txt) for Archaea', required=True)
    create_ncbi_tables_parser.add_argument('--gb',help='GenBank assembly summary file (assembly_summary_refseq.txt) for Bacteria', required=True)
    create_ncbi_tables_parser.add_argument('--ga',help='GenBank assembly summary file (assembly_summary_refseq.txt) for Archaea', required=True)
    create_ncbi_tables_parser.add_argument('-l','--genome_list',help='genome identifiers for genomes in GTDB')
    create_ncbi_tables_parser.add_argument('-o','--output_file')
    create_ncbi_tables_parser.add_argument('--silent', help="suppress output", action='store_true')

    # Create metadata tables for NCBI
    parse_ncbi_dir_parser = subparsers.add_parser('parse_ncbi_dir', formatter_class=CustomHelpFormatter,
                                                    description='Parse NCBI directories.')
    parse_ncbi_dir_parser.add_argument('-g',
                                      '--gtdb_genome_path_file', help='file indicating path to GTDB genomes.', required=True)
    parse_ncbi_dir_parser.add_argument('-o',
                                              '--output_file', help='Output directory.', required=True)
    parse_ncbi_dir_parser.add_argument('--silent', help="suppress output", action='store_true')


    # Parse NCBI Taxonomy files
    parse_ncbi_tax_parser = subparsers.add_parser('parse_ncbi_taxonomy', formatter_class=CustomHelpFormatter,
                                                description='Parse assembly summary file to generate taxonomy files.')
    parse_ncbi_tax_parser.add_argument('-t','--taxonomy_dir', help='directory containing NCBI taxonomy files')
    parse_ncbi_tax_parser.add_argument('--rb',help='RefSeq assembly summary file (assembly_summary_refseq.txt) for Bacteria', required=True)
    parse_ncbi_tax_parser.add_argument('--ra',help='RefSeq assembly summary file (assembly_summary_refseq.txt) for Archaea', required=True)
    parse_ncbi_tax_parser.add_argument('--gb',help='GenBank assembly summary file (assembly_summary_refseq.txt) for Bacteria', required=True)
    parse_ncbi_tax_parser.add_argument('--ga',help='GenBank assembly summary file (assembly_summary_refseq.txt) for Archaea', required=True)
    parse_ncbi_tax_parser.add_argument('-p','--output_prefix', help='output prefix')
    parse_ncbi_tax_parser.add_argument('--silent', help="suppress output", action='store_true')

    # Misc commands
    genome_dir_parser = subparsers.add_parser(
        'list_genomes', formatter_class=CustomHelpFormatter, description='Produce file indicating the directory of each genome.')
    genome_dir_parser.add_argument(
        'genome_dir', help='base directory leading to NCBI archaeal and bacterial genome assemblies')
    genome_dir_parser.add_argument('output_file', help='output metadata file')
    genome_dir_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    # Steps to move NCBI genomes to GTDB folders
    update_rfq_parser = subparsers.add_parser(
        'update_refseq', formatter_class=CustomHelpFormatter, description='Update Refseq genomes.')
    update_rfq_parser.add_argument('--ftp_refseq_directory', dest="ftp_refseq", required=True,
                                   help='base directory leading the the FTP repository for refseq')
    update_rfq_parser.add_argument('--new_refseq_directory', dest="output_dir",
                                   required=True, help='base directory leading the new repository for refseq')
    update_rfq_parser.add_argument('--ftp_genome_dirs_file', dest="ftp_genome_dirs", required=True,
                                   help='metadata file listing all directories for the FTP folder (generated by genome_dirs.py)')
    update_rfq_parser.add_argument('--old_genome_dirs_file', dest="old_genome_dirs", required=True,
                                   help='metadata file listing all directories from the previous NCBI update date  (generated by genome_dirs.py)')
    update_rfq_parser.add_argument('--arc_assembly_summary', required=True,
                                   help='metadata file downloaded from ncbi.')
    update_rfq_parser.add_argument('--bac_assembly_summary', required=True,
                                   help='metadata file downloaded from ncbi.')
    update_rfq_parser.add_argument('--cpus', type=int, default=1,
                                   help='Number of cpus')
    update_rfq_parser.add_argument('--dry_run',action='store_true',
                                   help='Run the pipeline without copying the files')
    update_rfq_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    update_gbk_parser = subparsers.add_parser(
        'update_genbank', formatter_class=CustomHelpFormatter, description='Update Genbank genomes.')
    update_gbk_parser.add_argument('--ftp_genbank_directory', dest="ftp_genbank", required=True,
                                   help='base directory leading the the FTP repository for genbank')
    update_gbk_parser.add_argument('--new_genbank_directory', dest="output_dir",
                                   required=True, help='base directory leading the new repository for genbank')
    update_gbk_parser.add_argument('--ftp_genbank_genome_dirs_file', dest="ftp_genbank_genome_dirs", required=True,
                                   help='metadata file listing all directories for the FTP folder (generated by ncbi_genome_dirs.py)')
    update_gbk_parser.add_argument('--old_genbank_genome_dirs_file', dest="old_genbank_genome_dirs", required=True,
                                   help='metadata file listing all directories from the previous NCBI update date  (generated by genome_dirs.py)')
    update_gbk_parser.add_argument('--new_refseq_genome_dirs_file', dest="new_refseq_genome_dirs", required=True,
                                   help='metadata file listing all directories from the previous NCBI update date  (generated by genome_dirs.py)')
    update_gbk_parser.add_argument('--arc_assembly_summary', required=True,
                                   help='Genbank metadata file downloaded from ncbi.')
    update_gbk_parser.add_argument('--bac_assembly_summary', required=True,
                                   help='Genbank metadata file downloaded from ncbi.')
    update_gbk_parser.add_argument('--cpus', type=int, default=1,
                                   help='Number of cpus')
    update_gbk_parser.add_argument('--dry_run',action='store_true',
                                   help='Run the pipeline without copying the files')
    update_gbk_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    # Steps to propagate GTDB Taxonomy
    propagate_gtdb_parser = subparsers.add_parser(
        'propagate_gtdb_taxonomy', formatter_class=CustomHelpFormatter, description='Propagating GTDB taxonomy to new release.')
    propagate_gtdb_parser.add_argument('--gtdb_metadata_prev', required=True,
                                   help='GTDB metadata for previous NCBI release.')
    propagate_gtdb_parser.add_argument('--gtdb_metadata_cur', required=True,
                                   help='GTDB metadata for current NCBI release.')
    propagate_gtdb_parser.add_argument('--taxonomy_file', required=True,
                                   help='Propagated GTDB taxonomy file.')
    propagate_gtdb_parser.add_argument('--rep_file', required=True,
                                   help='GTDB representatives file.')
    propagate_gtdb_parser.add_argument('-l', '--log', required=True, help="Log file")

    propagate_gtdb_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    # Update surveillance genome list
    add_survey_parser = subparsers.add_parser(
        'add_surveillance_genomes', formatter_class=CustomHelpFormatter,
        description='.')
    add_survey_parser.add_argument('--hostname', required=True)
    add_survey_parser.add_argument('-u', '--user',
                                  help='psql user', required=True)
    add_survey_parser.add_argument('-p', '--password',
                                  help='password for psql user', required=True)
    add_survey_parser.add_argument('-d', '--db',
                                  help='database.', required=True)
    add_survey_parser.add_argument('genome_list',
                                  help='surveillance genomes.')
    add_survey_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    # Convert names.dmp to a table
    # Update surveillance genome list
    add_names_dmp_parser = subparsers.add_parser(
        'add_names_dmp', formatter_class=CustomHelpFormatter,
        description='.')
    add_names_dmp_parser.add_argument('--hostname', required=True)
    add_names_dmp_parser.add_argument('-u', '--user',
                                  help='psql user', required=True)
    add_names_dmp_parser.add_argument('-p', '--password',
                                  help='password for psql user', required=True)
    add_names_dmp_parser.add_argument('-d', '--db',
                                  help='database.', required=True)
    add_names_dmp_parser.add_argument('-t','--taxonomy_dir', help='directory containing NCBI taxonomy files')
    add_names_dmp_parser.add_argument('--rb',help='RefSeq assembly summary file (assembly_summary_refseq.txt) for Bacteria', required=True)
    add_names_dmp_parser.add_argument('--ra',help='RefSeq assembly summary file (assembly_summary_refseq.txt) for Archaea', required=True)
    add_names_dmp_parser.add_argument('--gb',help='GenBank assembly summary file (assembly_summary_refseq.txt) for Bacteria', required=True)
    add_names_dmp_parser.add_argument('--ga',help='GenBank assembly summary file (assembly_summary_refseq.txt) for Archaea', required=True)
    add_names_dmp_parser.add_argument('--output_prefix', help='output prefix')
    add_names_dmp_parser.add_argument(
        '--silent', help="suppress output", action='store_true')



    # Steps to propagate GTDB Taxonomy
    update_propagated_tax_parser = subparsers.add_parser(
        'update_propagated_tax', formatter_class=CustomHelpFormatter,
        description='Push changed from prpagated taxonomy to new database.')
    update_propagated_tax_parser.add_argument('--hostname', required=True)
    update_propagated_tax_parser.add_argument('-u', '--user',
                                  help='psql user', required=True)
    update_propagated_tax_parser.add_argument('-p', '--password',
                                  help='password for psql user', required=True)
    update_propagated_tax_parser.add_argument('-d', '--db',
                                  help='database.', required=True)
    update_propagated_tax_parser.add_argument('--taxonomy_file', help='taxonomy file with genome tree taxonomy strings')
    update_propagated_tax_parser.add_argument('--metadata_file', help='metadata file for all genomes in GTDB')
    update_propagated_tax_parser.add_argument('--genome_list', help='only process genomes in this list')
    update_propagated_tax_parser.add_argument('--truncate_taxonomy',
                        help='truncate current taxonomy strings to just the domain before updating taxonomy',
                        action='store_true')
    update_propagated_tax_parser.add_argument('--rep_id_file', required=True,
                                       help='GTDB representatives file.')
    update_propagated_tax_parser.add_argument('-l', '--log', required=True, help="Log file")

    update_propagated_tax_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    set_gtdb_domain_parser = subparsers.add_parser(
        'set_gtdb_domain', formatter_class=CustomHelpFormatter,
        description='Set missing GTDB domain information to reflect NCBI domain.')
    set_gtdb_domain_parser.add_argument('--hostname', required=True)
    set_gtdb_domain_parser.add_argument('-u', '--user',
                                  help='psql user', required=True)
    set_gtdb_domain_parser.add_argument('-p', '--password',
                                  help='password for psql user', required=True)
    set_gtdb_domain_parser.add_argument('-d', '--db',
                                  help='database.', required=True)
    set_gtdb_domain_parser.add_argument('-l', '--log',
                                  help='Log file.', required=True)
    set_gtdb_domain_parser.add_argument(
        '--silent', help="suppress output.", action='store_true')

    ncbi_genome_category_parser = subparsers.add_parser('ncbi_genome_category', formatter_class=CustomHelpFormatter,
        description='Identify genomes marked by NCBI as being a MAG or SAG.')
    ncbi_genome_category_parser.add_argument('-g','--genbank_assembly_summary',
        help='file from NCBI indicating metadata for genome assemblies in GenBank (ftp://ftp.ncbi.nlm.nih.gov/genomes/ASSEMBLY_REPORTS/assembly_summary_genbank.txt)')
    ncbi_genome_category_parser.add_argument('-r','--refseq_assembly_summary',
        help='file from NCBI indicating metadata for genome assemblies in RefSeq (ftp://ftp.ncbi.nlm.nih.gov/genomes/ASSEMBLY_REPORTS/assembly_summary_refseq.txt)')
    ncbi_genome_category_parser.add_argument('-p','--genome_file', help='file indicating path to GTDB genome files')
    ncbi_genome_category_parser.add_argument('-o','--output_file', help='output file')
    ncbi_genome_category_parser.add_argument('-l', '--log', required=True, help="Log file")
    ncbi_genome_category_parser.add_argument('--silent', help="suppress output", action='store_true')


    # Steps to update LPSN Metadata
    lpsn_parser = subparsers.add_parser('lpsn',
                                        formatter_class=CustomHelpFormatter,
                                        description='Steps to update LPSN Metadata.')

    lpsn_subparser = lpsn_parser.add_subparsers(help='Command to process LPSN metadata',
                                                dest='lpsn_subparser_name')

    lpsn_parser_lpsn_wf = lpsn_subparser.add_parser('lpsn_wf',
                                                    add_help=True,
                                                    formatter_class=CustomHelpFormatter,
                                                    help='Full Pipeline Pull HTML and Parse HTML')
    lpsn_parser_lpsn_wf.add_argument(
        'output_dir', help='Output directory.')
    lpsn_parser_lpsn_wf.add_argument(
        '--silent', help="suppress output", action='store_true')

    lpsn_parser_pull = lpsn_subparser.add_parser('pull_html',
                                                 add_help=True,
                                                 formatter_class=CustomHelpFormatter,
                                                 help='Get files from LPSN listing all genera and species.')
    lpsn_parser_pull.add_argument(
        'output_dir', help='Output directory.')
    lpsn_parser_pull.add_argument(
        '--skip_taxa_per_letter_dl', help="skip downloading the set of taxa under each rank; assumes this information has previously been downloaded", 
        action='store_true')
    lpsn_parser_pull.add_argument(
        '--silent', help="suppress output", action='store_true')

    lpsn_parser_parse_html = lpsn_subparser.add_parser('parse_html',
                                                       add_help=True,
                                                       formatter_class=CustomHelpFormatter,
                                                       help='Parse HTML files.')
                                                       
    lpsn_parser_parse_html.add_argument(
        'input_dir', help='Directory containing all genus HTML files.')
    lpsn_parser_parse_html.add_argument(
        'output_dir', help='Output directory.')
    lpsn_parser_parse_html.add_argument(
        '--silent', help="suppress output", action='store_true')

    # Steps to update BadDive Metadata
    bacdive_parser = subparsers.add_parser('bacdive',
                                           formatter_class=CustomHelpFormatter,
                                           description='Steps to update Bacdive Metadata.')

    bacdive_subparser = bacdive_parser.add_subparsers(help='Command to process Bacdive metadata',
                                                      dest='bacdive_subparser_name')

    bacdive_parser_dl_strains = bacdive_subparser.add_parser('download_strains',
                                                             add_help=True,
                                                             formatter_class=CustomHelpFormatter,
                                                             help='Produce metadata files describing type genera, species, and strains according to DSMZ.')
    bacdive_parser_dl_strains.add_argument(
        '--username', help='Username to log to Bacdive API.', required=True)
    bacdive_parser_dl_strains.add_argument(
        '-p', '--pwd', dest='pwd', help='Username to log to Bacdive API.', required=True)
    bacdive_parser_dl_strains.add_argument(
        'output_dir', help='Output directory.')
    bacdive_parser_dl_strains.add_argument(
        '--silent', help="suppress output", action='store_true')
        

	# NCBI Strain Parser 
    ncbi_strains_parser = subparsers.add_parser(
        'ncbi_strains', formatter_class=CustomHelpFormatter, description='NCBI Strain Parser.')
    ncbi_strains_parser.add_argument('--genome_dir_file',
                        help='file indicating path to all genomes directories')
    ncbi_strains_parser.add_argument('--assembly_summary_bacteria_genbank',
                        help='assembly_summary_genbank.txt downloaded from NCBI',required=True)
    ncbi_strains_parser.add_argument('--assembly_summary_archaea_genbank',
                        help='assembly_summary_genbank.txt downloaded from NCBI',required=True)
    ncbi_strains_parser.add_argument('--assembly_summary_bacteria_refseq',
                        help='assembly_summary_bacteria_refseq.txt downloaded from NCBI',required=True)
    ncbi_strains_parser.add_argument('--assembly_summary_archaea_refseq',
                        help='assembly_summary_archaea_refseq.txt downloaded from NCBI',required=True)
    ncbi_strains_parser.add_argument('-l', '--log', required=True, help="Log file")

    ncbi_strains_parser.add_argument('--out_dir', help='output directory')
    ncbi_strains_parser.add_argument(
        '--silent', help="suppress output", action='store_true')
        
    # Tools to combine Medata from different databases.
    strains_parser = subparsers.add_parser('strains',
                                           add_help=True,
                                           formatter_class=CustomHelpFormatter,
                                           description='Tools to combine metadata from different databases.')
    strains_subparser = strains_parser.add_subparsers(help='Tools to combine metadata from different databases.',
                                                      dest='strains_subparser_name')

    strains_parser_date = strains_subparser.add_parser('date_table',
                                                       add_help=True,
                                                       formatter_class=CustomHelpFormatter,
                                                       help='Generate table with LPSN year or priority for species and subspecies names.')
    strains_parser_date.add_argument('--lpsn_scraped_species_info', 
                        help="LPSN species file created by LPSN website parsing (lpsn_species.tsv from 'gtdb_migration_tk lpsn parse_html').",
                        required=True)
    strains_parser_date.add_argument('--lpsn_gss_file', 
                        help="table from lpsn.dsmz.de with nomenclature information (lpsn_gss_<date>.csv)",
                        required=True)
        
    strains_parser_date.add_argument('--output_file',
                                     help='Output file.')
    strains_parser_date.add_argument(
        '--silent', help="suppress output", action='store_true')

    strains_parser_type = strains_subparser.add_parser('type_table',
                                                       add_help=True,
                                                       formatter_class=CustomHelpFormatter,
                                                       help='Generate table indicating metadata from LPSN and DSMZ for each species name.')

    strains_parser_type.add_argument('--lpsn_gss_file', 
                                    help="table from lpsn.dsmz.de with nomenclature information (lpsn_gss_<date>.csv)",
                                    required=True)
    strains_parser_type.add_argument('--lpsn_dir',
                                     help='Directory including the 3 LPSN result files (lpsn_genera.tsv, lpsn_species.tsv, and lpsn_strains.tsv ).',
                                    required=True)
    strains_parser_type.add_argument('--dsmz_dir',
                                     help='Directory including the 3 DSMZ result files (dsmz_strains.tsv, dsmz_species.tsv, and dsmz_genera.tsv ).',
                                    required=True)
    strains_parser_type.add_argument('--year_table',
                                     help='Date table generated by generate_date_table.py.',
                                    required=True)
    strains_parser_type.add_argument('--metadata_file',
                                     help='Metadata file generated by version of GTDB currently being prepared for next release',
                                    required=True)
    strains_parser_type.add_argument(
        '--ncbi_names', help='NCBI names.dmp file',
                                    required=True)
    strains_parser_type.add_argument(
        '--ncbi_nodes', help='NCBI nodes.dmp file',
                                    required=True)
    strains_parser_type.add_argument('--cpus', help='Number of threads.',
                                     type=int, default=1)
    strains_parser_type.add_argument('--output_dir', 
                                    help='Output directory.',
                                    required=True)
    strains_parser_type.add_argument(
        '--silent', help="suppress output", action='store_true')

    overview_parser = subparsers.add_parser('overview',
                                            formatter_class=CustomHelpFormatter,
                                            help='Compare the Metadata file from the previous version with the new one.')
    overview_parser.add_argument(
        '--previous_metadata_file', help='file indicating metadata of each genome in previous GTDB version.', required=True)
    overview_parser.add_argument(
        '--new_metadata_file', help='file indicating metadata of each genome in latest GTDB version.', required=True)
    overview_parser.add_argument(
        '--only_ncbi', help='Output file.', action='store_true')
    overview_parser.add_argument(
        '--use_formatted_id', help='Output file.', action='store_true')
    overview_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    metafield_parser = subparsers.add_parser('compare_field',
                                             formatter_class=CustomHelpFormatter,
                                             help='Compare a specific metadata field between to metadata files.')
    metafield_parser.add_argument(
        '--previous_metadata_file', help='file indicating metadata of each genome in previous GTDB version.', required=True)
    metafield_parser.add_argument(
        '--new_metadata_file', help='file indicating metadata of each genome in latest GTDB version.', required=True)
    metafield_parser.add_argument(
        '--field_of_interest', help='common field to compare between files.', required=True)
    metafield_parser.add_argument(
        '--output_file', help='Output file.', required=True)
    metafield_parser.add_argument(
        '--only_ncbi', help='Output file.', action='store_true')
    metafield_parser.add_argument(
        '--silent', help="suppress output", action='store_true')

    marker_overview_parser = subparsers.add_parser('compare_markers',
                                            formatter_class=CustomHelpFormatter,
                                            help='Compare marker frequencies between 2 releases.')
    marker_overview_parser.add_argument(
        'first_domain_report', help='File generated from gtdb power domain report from early release.')
    marker_overview_parser.add_argument(
        'second_domain_report', help='File generated from gtdb power domain report from latest release.')
    marker_overview_parser.add_argument(
        'output_file', help='Output file.')
    marker_overview_parser.add_argument(
        '--only_ncbi', help='Only compare NCBI genomes.', action='store_true')
    marker_overview_parser.add_argument(
        '--use_formatted_id', help='Output file.', action='store_true')
    marker_overview_parser.add_argument(
        '--silent', help="suppress output", action='store_true')
        
        
    # Lists and pseudo-trees for new representatives, polyphyletic taxa, rogue genomes, and genomes with modified NCBI names
    curation_lists_parser = subparsers.add_parser('curation_lists', 
                                                formatter_class=CustomHelpFormatter, 
                                                description='Lists and pseudo-trees for new representatives, polyphyletic taxa, rogue genomes, and genomes with modified NCBI names.')
    curation_lists_parser.add_argument('--gtdb_init_taxonomy', help='initial taxonomy for latest release')
    curation_lists_parser.add_argument('--gtdb_sp_clusters', help='species clusters for latest release')
    curation_lists_parser.add_argument('--gtdb_prev_sp_clusters', help='species clusters for previous release')
    curation_lists_parser.add_argument('--gtdb_decorate_table', help='decoration table produced by PhyloRank decorate')
    curation_lists_parser.add_argument('--domain', help='domain to append to output files', choices=['bac', 'ar'])
    curation_lists_parser.add_argument('--output_dir', help='output directory')
    curation_lists_parser.add_argument('--silent', help="suppress output", action='store_true')

    check_unique_strains_parser = subparsers.add_parser('check_unique_strains',
                                                  formatter_class=CustomHelpFormatter,
                                                  description='Lists and pseudo-trees for new representatives, polyphyletic taxa, rogue genomes, and genomes with modified NCBI names.')

    check_unique_strains_parser.add_argument('--node', help='initial taxonomy for latest release')
    check_unique_strains_parser.add_argument('--name', help='species clusters for latest release')
    check_unique_strains_parser.add_argument('-m','--metadata_file', help='species clusters for latest release')
    check_unique_strains_parser.add_argument('-o', '--output_file', help='Output file.')

    # get and check options
    args = None
    if len(sys.argv) == 1 or sys.argv[1] in {'-h', '--help'}:
        print_help()
        sys.exit(0)
    else:
        args = parser.parse_args()
        
    silent = False
    if hasattr(args, 'silent'):
        silent = args.silent

    try:
        logger_setup(os.path.dirname(args.log),
                     os.path.basename(args.log),
                     'GTDB Migration Tk',
                     __version__,
                     silent)
    except:
        logger_setup('.',
                     'gtdb_migration_tk.log',
                     'GTDB Migration Tk',
                     __version__,
                     silent)

    # do what we came here to do
    try:
        parser = OptionsParser()
        if(False):
            import cProfile
            cProfile.run('parser.parse_options(args)', 'prof')
        elif False:
            import pdb
            pdb.run(parser.parse_options(args))
        else:
            parser.parse_options(args)
    except SystemExit:
        print("\n  Controlled exit resulting from an unrecoverable error or warning.")
    except:
        print("\nUnexpected error:", sys.exc_info()[0])
        raise
